<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عقارك - منصة العقارات المتكاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* CSS styles remain the same - no changes needed here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 40px;
            margin-left: 10px;
        }
        
        .logo h1 {
            color: #3498db;
            font-size: 24px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #3498db;
        }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }
        
        .btn-outline:hover {
            background-color: #3498db;
            color: white;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* User Info Styles */
        .user-info {
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
        }
        
        .hero h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        .hero p {
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto 30px;
        }
        
        .search-container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
        }
        
        .search-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }
        
        /* Categories Section */
        .categories {
            padding: 60px 0;
            background-color: #fff;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 40px;
            font-size: 28px;
            color: #333;
        }
        
        .category-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .category-tab {
            padding: 10px 20px;
            margin: 5px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-tab.active {
            background-color: #3498db;
            color: white;
        }
        
        .category-tab:hover {
            background-color: #e0e0e0;
        }
        
        .category-tab.active:hover {
            background-color: #2980b9;
        }
        
        /* Properties Section */
        .properties {
            padding: 60px 0;
        }
        
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .property-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .property-image {
            position: relative;
            height: 200px;
            overflow: hidden;
        }
        
        .property-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .property-card:hover .property-image img {
            transform: scale(1.05);
        }
        
        .property-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-sale {
            background-color: #e74c3c;
            color: white;
        }
        
        .badge-rent {
            background-color: #2ecc71;
            color: white;
        }
        
        .property-content {
            padding: 20px;
        }
        
        .property-card-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .property-card-price {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .price-sale {
            color: #e74c3c;
        }
        
        .price-rent {
            color: #2ecc71;
        }
        
        .property-card-address {
            color: #777;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .property-card-address i {
            margin-left: 5px;
        }
        
        .property-card-features {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .property-feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
        }
        
        .property-feature i {
            margin-bottom: 5px;
            color: #3498db;
        }
        
        .view-details-btn {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .view-details-btn:hover {
            background-color: #2980b9;
        }
        
        .btn-favorite {
            background-color: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        .btn-favorite:hover {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-favorite.active {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Property Detail Page */
        .property-detail-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .property-gallery {
            position: relative;
            height: 400px;
        }
        
        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .badge-sale-detail {
            background-color: #e74c3c;
            color: white;
        }
        
        .badge-rent-detail {
            background-color: #2ecc71;
            color: white;
        }
        
        .thumbnails {
            display: flex;
            padding: 15px;
            gap: 10px;
            overflow-x: auto;
        }
        
        .thumbnail {
            width: 100px;
            height: 80px;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .property-info {
            padding: 30px;
        }
        
        .property-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .property-price {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .price-sale-detail {
            color: #e74c3c;
        }
        
        .price-rent-detail {
            color: #2ecc71;
        }
        
        .property-address {
            color: #777;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .property-address i {
            margin-left: 10px;
        }
        
        .property-description {
            margin-bottom: 30px;
            line-height: 1.8;
        }
        
        .property-features {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }
        
        .feature i {
            font-size: 24px;
            color: #3498db;
            margin-left: 15px;
        }
        
        .feature-value {
            font-weight: 700;
            font-size: 18px;
            display: block;
        }
        
        .feature-label {
            color: #777;
            font-size: 14px;
        }
        
        .amenities {
            margin-bottom: 30px;
        }
        
        .amenities h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .amenity {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .amenity i {
            color: #2ecc71;
            margin-left: 8px;
        }
        
        .property-map {
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .owner-info {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .owner-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .owner-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 15px;
        }
        
        .owner-details h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .owner-details p {
            color: #777;
            font-size: 14px;
        }
        
        .owner-contact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
        }
        
        .contact-item i {
            width: 40px;
            height: 40px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
        }
        
        .contact-item span {
            color: #777;
        }
        
        .property-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn-detail {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            text-align: center;
        }
        
        /* Contact Page */
        .contact-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .contact-header {
            background-color: #3498db;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .contact-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            padding: 40px;
        }
        
        .info-card {
            text-align: center;
            padding: 25px;
            border-radius: 10px;
            background-color: #f9f9f9;
            transition: transform 0.3s;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
        }
        
        .info-card i {
            font-size: 36px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .info-card h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .contact-form {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .contact-map {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: left;
        }
        
        /* Breadcrumb */
        .breadcrumb {
            background-color: #f9f9f9;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        
        .breadcrumb-list {
            display: flex;
            list-style: none;
        }
        
        .breadcrumb-list li {
            margin-left: 10px;
        }
        
        .breadcrumb-list li:not(:last-child)::after {
            content: '/';
            margin-right: 10px;
            color: #777;
        }
        
        .breadcrumb-list li a {
            color: #777;
            text-decoration: none;
        }
        
        .breadcrumb-list li a:hover {
            color: #3498db;
        }
        
        /* Search Results */
        .search-results {
            padding: 40px 0;
            background-color: #f9f9f9;
        }
        
        .search-results-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: #333;
        }
        
        /* Favorites Page */
        .favorites-page {
            padding: 40px 0;
        }
        
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .no-results i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .no-results h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .no-results p {
            color: #777;
            margin-bottom: 25px;
        }
        
        /* Owner Dashboard */
        .dashboard-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .dashboard-header {
            background-color: #3498db;
            color: white;
            padding: 20px 30px;
        }
        
        .dashboard-header h2 {
            font-size: 24px;
        }
        
        .dashboard-content {
            display: flex;
            min-height: 600px;
        }
        
        .sidebar {
            width: 250px;
            background-color: #f9f9f9;
            padding: 30px 0;
        }
        
        .sidebar ul {
            list-style: none;
        }
        
        .sidebar li {
            margin-bottom: 5px;
        }
        
        .sidebar a {
            display: block;
            padding: 12px 30px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .sidebar a:hover {
            background-color: #e0e0e0;
        }
        
        .sidebar li.active a {
            background-color: #3498db;
            color: white;
        }
        
        .dashboard-main {
            flex: 1;
            padding: 30px;
        }
        
        .dashboard-section {
            display: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 22px;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-available {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-sold {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .report-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #777;
        }
        
        .report-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }
        
        .report-details {
            margin-top: 30px;
        }
        
        .report-table-container {
            overflow-x: auto;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        .report-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        .conversations-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .conversation {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .conversation-user {
            display: flex;
            align-items: center;
        }
        
        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 15px;
        }
        
        .conversation-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .conversation-email {
            font-size: 14px;
            color: #777;
        }
        
        .conversation-date {
            font-size: 14px;
            color: #777;
        }
        
        .conversation-message {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .conversation-actions {
            display: flex;
            gap: 10px;
        }
        
        .no-conversations {
            text-align: center;
            padding: 60px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .no-conversations i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .no-conversations h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .no-conversations p {
            color: #777;
        }
        
        /* Request Card Styles */
        .request-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .request-info h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        
        .request-type {
            background-color: #e3f2fd;
            color: #0277bd;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .request-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff8e1;
            color: #ffa000;
        }
        
        .status-accepted {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-rejected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .request-user, .request-message, .request-offer, .request-date {
            margin-bottom: 10px;
        }
        
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .no-requests {
            text-align: center;
            padding: 40px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .no-requests i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .no-requests h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .no-requests p {
            color: #777;
        }
        
        /* Image Upload Styles */
        .image-upload-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .image-preview img {
            width: 100px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        /* Footer */
        footer {
            background-color: #333;
            color: white;
            padding: 60px 0 30px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .footer-column h3 {
            font-size: 20px;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .footer-column h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 2px;
            background-color: #3498db;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 10px;
        }
        
        .footer-column ul li a {
            color: #bbb;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-column ul li a:hover {
            color: #3498db;
        }
        
        .footer-column p {
            color: #bbb;
            line-height: 1.8;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: white;
            transition: background-color 0.3s;
        }
        
        .social-link:hover {
            background-color: #3498db;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #bbb;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .dashboard-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li {
                margin: 5px;
            }
            
            .hero h2 {
                font-size: 28px;
            }
            
            .property-features {
                flex-direction: column;
                gap: 10px;
            }
            
            .property-actions {
                flex-direction: column;
            }
            
            .owner-contact {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 0 15px;
            }
            
            .hero {
                padding: 60px 0;
            }
            
            .hero h2 {
                font-size: 24px;
            }
            
            .hero p {
                font-size: 16px;
            }
            
            .section-title {
                font-size: 22px;
            }
            
            .property-title {
                font-size: 22px;
            }
            
            .property-price {
                font-size: 20px;
            }
            
            .contact-info {
                grid-template-columns: 1fr;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error Message */
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background-color: #ffebee;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="https://i.imgur.com/5a5VwzR.png" alt="عقارك">
                <h1>عقارك</h1>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" onclick="showHomePage()">الرئيسية</a></li>
                    <li><a href="#" onclick="showPropertiesListing()">عقارات للبيع</a></li>
                    <li><a href="#" onclick="showRentListing()">عقارات للإيجار</a></li>
                    <li><a href="#" onclick="showContactPage()">اتصل بنا</a></li>
                    <li id="dashboard-link" style="display: none;"><a href="#" onclick="showOwnerDashboard()">لوحة التحكم</a></li>
                </ul>
            </nav>
            
            <div id="auth-buttons" class="auth-buttons">
                <button class="btn btn-outline" onclick="showModal('login-modal')">تسجيل الدخول</button>
                <button class="btn btn-primary" onclick="showModal('register-modal')">إنشاء حساب</button>
            </div>
            
            <div id="user-info" class="user-info">
                <span id="user-name" class="user-name"></span>
                <button class="btn btn-outline" onclick="logout()">تسجيل الخروج</button>
            </div>
        </div>
    </header>
    
    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h2>ابحث عن عقار أحلامك</h2>
            <p>منصة شاملة لبيع وشراء وتأجير العقارات في جميع أنحاء المملكة</p>
            
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="ابحث عن مدينة، حي أو نوع عقار...">
                <button class="search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </section>
    
    <!-- Categories Section -->
    <section class="categories">
        <div class="container">
            <h2 class="section-title">تصفح حسب الفئة</h2>
            
            <div class="category-tabs">
                <button class="category-tab active" onclick="filterProperties('all')">الكل</button>
                <button class="category-tab" onclick="filterProperties('sale')">للبيع</button>
                <button class="category-tab" onclick="filterProperties('rent')">للإيجار</button>
                <button class="category-tab" onclick="filterProperties('villa')">فلل</button>
                <button class="category-tab" onclick="filterProperties('apartment')">شقق</button>
                <button class="category-tab" onclick="filterProperties('land')">أراضي</button>
            </div>
        </div>
    </section>
    
    <!-- Home Page -->
    <section id="home-page" class="properties">
        <div class="container">
            <h2 class="section-title">عقارات مميزة</h2>
            
            <div id="home-properties-grid" class="properties-grid">
                <!-- Properties will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Properties for Sale Listing -->
    <section id="properties-listing" class="properties" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">عقارات للبيع</h2>
                
                <div class="search-container" style="max-width: 400px;">
                    <input type="text" id="sale-search-input" class="search-input" placeholder="ابحث في عقارات البيع...">
                    <button class="search-btn" onclick="performSaleSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <div id="sale-properties-grid" class="properties-grid">
                <!-- Properties will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Properties for Rent Listing -->
    <section id="rent-listing" class="properties" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">عقارات للإيجار</h2>
                
                <div class="search-container" style="max-width: 400px;">
                    <input type="text" id="rent-search-input" class="search-input" placeholder="ابحث في عقارات الإيجار...">
                    <button class="search-btn" onclick="performRentSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <div id="rent-properties-grid" class="properties-grid">
                <!-- Properties will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Property Detail -->
    <section id="property-detail" class="property-detail" style="display: none;">
        <div class="container">
            <div class="breadcrumb">
                <ul id="breadcrumb-list" class="breadcrumb-list">
                    <!-- Breadcrumb will be updated here -->
                </ul>
            </div>
            
            <div class="property-detail-container">
                <div class="property-gallery">
                    <img id="main-image" src="" alt="Property Image" class="main-image">
                    <div id="detail-badge" class="image-badge">للبيع</div>
                    
                    <div class="thumbnails">
                        <div class="thumbnail">
                            <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" alt="Thumbnail 1" onclick="changeImage('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80')">
                        </div>
                        <div class="thumbnail">
                            <img src="https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" alt="Thumbnail 2" onclick="changeImage('https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80')">
                        </div>
                        <div class="thumbnail">
                            <img src="https://images.unsplash.com/photo-1556911220-e15b29be8c8f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" alt="Thumbnail 3" onclick="changeImage('https://images.unsplash.com/photo-1556911220-e15b29be8c8f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80')">
                        </div>
                    </div>
                </div>
                
                <div class="property-info">
                    <h1 id="detail-title" class="property-title">عنوان العقار</h1>
                    <div id="detail-price" class="property-price price-sale-detail">السعر</div>
                    <div id="detail-address" class="property-address">
                        <i class="fas fa-map-marker-alt"></i>
                        العنوان
                    </div>
                    
                    <p id="detail-description" class="property-description">وصف العقار</p>
                    
                    <div class="property-features">
                        <!-- Features will be loaded here -->
                    </div>
                    
                    <div class="amenities">
                        <h3>المرافق</h3>
                        <div class="amenities-list">
                            <!-- Amenities will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="property-map" class="property-map"></div>
                    
                    <div class="owner-info">
                        <div class="owner-header">
                            <img id="owner-avatar-img" src="" alt="Owner" class="owner-avatar">
                            <div class="owner-details">
                                <h3 id="owner-name">اسم المالك</h3>
                                <p>مالك العقار</p>
                            </div>
                        </div>
                        
                        <div class="owner-contact">
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span id="owner-phone">رقم الهاتف</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span id="owner-email">البريد الإلكتروني</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="property-actions">
                        <button id="detail-favorite-btn" class="btn btn-outline btn-detail btn-favorite" onclick="addToFavorites('')">
                            <i class="fas fa-heart"></i> حفظ العقار
                        </button>
                        <button class="btn btn-primary btn-detail" onclick="showPhoneNumber()">
                            <i class="fas fa-phone"></i> إظهار رقم الهاتف
                        </button>
                        <button class="btn btn-primary btn-detail" onclick="openContactModal()">
                            <i class="fas fa-envelope"></i> إرسال رسالة
                        </button>
                        <button id="request-btn" class="btn btn-success btn-detail" onclick="showRequestModal()">
                            <i class="fas fa-handshake"></i> طلب <span id="request-type-text">شراء</span>
                        </button>
                        <button class="btn btn-outline btn-detail" onclick="goBackToListing()">
                            <i class="fas fa-arrow-right"></i> العودة للقائمة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Search Results -->
    <section id="search-results" class="search-results" style="display: none;">
        <div class="container">
            <h2 class="search-results-title">نتائج البحث</h2>
            
            <div id="search-results-container" class="properties-grid">
                <!-- Search results will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Sale Search Results -->
    <section id="sale-search-results" class="search-results" style="display: none;">
        <div class="container">
            <h2 class="search-results-title">نتائج بحث عقارات البيع</h2>
            
            <div id="sale-search-results-container" class="properties-grid">
                <!-- Sale search results will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Rent Search Results -->
    <section id="rent-search-results" class="search-results" style="display: none;">
        <div class="container">
            <h2 class="search-results-title">نتائج بحث عقارات الإيجار</h2>
            
            <div id="rent-search-results-container" class="properties-grid">
                <!-- Rent search results will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Favorites Page -->
    <section id="favorites-page" class="favorites-page" style="display: none;">
        <div class="container">
            <h2 class="section-title">عقاراتي المفضلة</h2>
            
            <div id="favorites-grid" class="favorites-grid">
                <!-- Favorites will be loaded here -->
            </div>
        </div>
    </section>
    
    <!-- Contact Page -->
    <section id="contact-page" class="contact-page" style="display: none;">
        <div class="container">
            <div class="breadcrumb">
                <ul id="breadcrumb-list" class="breadcrumb-list">
                    <!-- Breadcrumb will be updated here -->
                </ul>
            </div>
            
            <div class="contact-container">
                <div class="contact-header">
                    <h2>اتصل بنا</h2>
                    <p>نحن هنا لمساعدتك في العثور على العقار المثالي</p>
                </div>
                
                <div class="contact-info">
                    <div class="info-card">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>العنوان</h3>
                        <p>شارع الملك فهد، حي النخيل<br>الرياض، المملكة العربية السعودية</p>
                    </div>
                    
                    <div class="info-card">
                        <i class="fas fa-phone"></i>
                        <h3>الهاتف</h3>
                        <p>+966 50 123 4567<br>السبت - الخميس: 9 ص - 8 م</p>
                    </div>
                    
                    <div class="info-card">
                        <i class="fas fa-envelope"></i>
                        <h3>البريد الإلكتروني</h3>
                        <p>info@aqarak.com<br>نرد على رسائلك خلال 24 ساعة</p>
                    </div>
                </div>
                
                <div class="contact-form">
                    <h3>أرسل لنا رسالة</h3>
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">الاسم</label>
                            <input type="text" id="contact-name" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-email">البريد الإلكتروني</label>
                            <input type="email" id="contact-email" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-subject">الموضوع</label>
                            <input type="text" id="contact-subject" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact-message">الرسالة</label>
                            <textarea id="contact-message" class="form-control" required></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">إرسال الرسالة</button>
                    </form>
                </div>
                
                <div id="contact-map" class="contact-map"></div>
            </div>
        </div>
    </section>
    
    <!-- Owner Dashboard -->
    <section id="owner-dashboard" class="dashboard" style="display: none;">
        <div class="container">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h2>لوحة التحكم</h2>
                </div>
                
                <div class="dashboard-content">
                    <div class="sidebar">
                        <ul>
                            <li class="active">
                                <a href="#" onclick="showDashboardSection('properties')">العقارات</a>
                            </li>
                            <li>
                                <a href="#" onclick="showDashboardSection('agents')">الوكلاء</a>
                            </li>
                            <li>
                                <a href="#" onclick="showDashboardSection('messages')">الرسائل</a>
                            </li>
                            <li>
                                <a href="#" onclick="showDashboardSection('requests')">الطلبات</a>
                            </li>
                            <li>
                                <a href="#" onclick="showDashboardSection('reports')">التقارير</a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="dashboard-main">
                        <!-- Properties Section -->
                        <div id="dashboard-properties" class="dashboard-section">
                            <div class="section-header">
                                <h3 class="section-title">العقارات</h3>
                                <button class="btn btn-primary" onclick="showAddPropertyForm()">إضافة عقار جديد</button>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>العنوان</th>
                                            <th>السعر</th>
                                            <th>المدينة</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="properties-tbody">
                                        <!-- Properties will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Agents Section -->
                        <div id="dashboard-agents" class="dashboard-section" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">الوكلاء</h3>
                                <button class="btn btn-primary" onclick="showAddAgentForm()">إضافة وكيل جديد</button>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>الاسم</th>
                                            <th>الهاتف</th>
                                            <th>البريد الإلكتروني</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agents-tbody">
                                        <!-- Agents will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Messages Section -->
                        <div id="dashboard-messages" class="dashboard-section" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">الرسائل</h3>
                            </div>
                            
                            <div id="conversations-container" class="conversations-container">
                                <!-- Conversations will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Requests Section -->
                        <div id="dashboard-requests" class="dashboard-section" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">طلبات الشراء/الإيجار</h3>
                            </div>
                            
                            <div id="requests-container">
                                <!-- Requests will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Reports Section -->
                        <div id="dashboard-reports" class="dashboard-section" style="display: none;">
                            <div class="section-header">
                                <h3 class="section-title">التقارير</h3>
                            </div>
                            
                            <div id="reports-container">
                                <!-- Reports will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>عقارك</h3>
                    <p>منصة شاملة لبيع وشراء وتأجير العقارات في جميع أنحاء المملكة العربية السعودية.</p>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>روابط سريعة</h3>
                    <ul>
                        <li><a href="#" onclick="showHomePage()">الرئيسية</a></li>
                        <li><a href="#" onclick="showPropertiesListing()">عقارات للبيع</a></li>
                        <li><a href="#" onclick="showRentListing()">عقارات للإيجار</a></li>
                        <li><a href="#" onclick="showContactPage()">اتصل بنا</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>خدماتنا</h3>
                    <ul>
                        <li><a href="#">بيع العقارات</a></li>
                        <li><a href="#">شراء العقارات</a></li>
                        <li><a href="#">تأجير العقارات</a></li>
                        <li><a href="#">تقييم العقارات</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>تواصل معنا</h3>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> الرياض، المملكة العربية السعودية</li>
                        <li><i class="fas fa-phone"></i> +966 50 123 4567</li>
                        <li><i class="fas fa-envelope"></i> info@aqarak.com</li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2023 عقارك. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تسجيل الدخول</h3>
                <button class="close-btn" onclick="closeModal('login-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">البريد الإلكتروني</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">كلمة المرور</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox"> تذكرني
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">تسجيل الدخول</button>
                </form>
            </div>
            <div class="modal-footer">
                <p>ليس لديك حساب؟ <a href="#" onclick="showModal('register-modal'); closeModal('login-modal');">إنشاء حساب جديد</a></p>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إنشاء حساب جديد</h3>
                <button class="close-btn" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">الاسم الكامل</label>
                        <input type="text" id="register-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">البريد الإلكتروني</label>
                        <input type="email" id="register-email" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">كلمة المرور</label>
                        <input type="password" id="register-password" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password-confirm">تأكيد كلمة المرور</label>
                        <input type="password" id="register-password-confirm" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox"> أوافق على <a href="#">الشروط والأحكام</a>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">إنشاء حساب</button>
                </form>
            </div>
            <div class="modal-footer">
                <p>لديك حساب بالفعل؟ <a href="#" onclick="showModal('login-modal'); closeModal('register-modal');">تسجيل الدخول</a></p>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إرسال رسالة</h3>
                <button class="close-btn" onclick="closeContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="contact-modal-form">
                    <div class="form-group">
                        <label for="contact-modal-name">الاسم</label>
                        <input type="text" id="contact-modal-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-modal-phone">رقم الهاتف</label>
                        <input type="tel" id="contact-modal-phone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-modal-email">البريد الإلكتروني</label>
                        <input type="email" id="contact-modal-email" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-modal-message">الرسالة</label>
                        <textarea id="contact-modal-message" class="form-control" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">إرسال الرسالة</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Request Modal -->
    <div id="request-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">طلب <span id="request-type-text">شراء</span></h3>
                <button class="close-btn" onclick="closeModal('request-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="request-form">
                    <div class="form-group">
                        <label for="request-message">رسالة للمالك</label>
                        <textarea id="request-message" class="form-control" rows="4" placeholder="أكتب رسالة للمالك..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="request-offer">عرض السعر (اختياري)</label>
                        <input type="number" id="request-offer" class="form-control" placeholder="العرض المقترح">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="request-terms"> أوافق على الشروط والأحكام
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">إرسال الطلب</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Property Modal -->
    <div id="add-property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة عقار جديد</h3>
                <button class="close-btn" onclick="closeModal('add-property-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-property-form">
                    <div class="form-group">
                        <label for="property-title">عنوان العقار</label>
                        <input type="text" id="property-title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-price">السعر</label>
                        <input type="number" id="property-price" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-city">المدينة</label>
                        <input type="text" id="property-city" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-district">الحي</label>
                        <input type="text" id="property-district" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-area">المساحة (م²)</label>
                        <input type="number" id="property-area" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-bedrooms">عدد غرف النوم</label>
                        <input type="number" id="property-bedrooms" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="property-bathrooms">عدد الحمامات</label>
                        <input type="number" id="property-bathrooms" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="property-description">الوصف</label>
                        <textarea id="property-description" class="form-control"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-type">نوع العقار</label>
                        <select id="property-type" class="form-control" required>
                            <option value="sale">للبيع</option>
                            <option value="rent">للإيجار</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-status">الحالة</label>
                        <select id="property-status" class="form-control" required>
                            <option value="available">متاح</option>
                            <option value="sold">مباع</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="property-images">صور العقار</label>
                        <div class="image-upload-container">
                            <div id="image-preview" class="image-preview"></div>
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('property-images').click()">
                                <i class="fas fa-upload"></i> رفع الصور
                            </button>
                            <input type="file" id="property-images" class="form-control" multiple accept="image/*" style="display: none;">
                        </div>
                        <small>يمكنك رفع ما يصل إلى 5 صور</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">إضافة العقار</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Property Modal -->
    <div id="edit-property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل العقار</h3>
                <button class="close-btn" onclick="closeModal('edit-property-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-property-form">
                    <input type="hidden" id="edit-property-id">
                    
                    <div class="form-group">
                        <label for="edit-property-title">عنوان العقار</label>
                        <input type="text" id="edit-property-title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-price">السعر</label>
                        <input type="number" id="edit-property-price" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-city">المدينة</label>
                        <input type="text" id="edit-property-city" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-district">الحي</label>
                        <input type="text" id="edit-property-district" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-area">المساحة (م²)</label>
                        <input type="number" id="edit-property-area" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-bedrooms">عدد غرف النوم</label>
                        <input type="number" id="edit-property-bedrooms" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-bathrooms">عدد الحمامات</label>
                        <input type="number" id="edit-property-bathrooms" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-description">الوصف</label>
                        <textarea id="edit-property-description" class="form-control"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-type">نوع العقار</label>
                        <select id="edit-property-type" class="form-control" required>
                            <option value="sale">للبيع</option>
                            <option value="rent">للإيجار</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-status">الحالة</label>
                        <select id="edit-property-status" class="form-control" required>
                            <option value="available">متاح</option>
                            <option value="sold">مباع</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-property-images">صور العقار</label>
                        <div class="image-upload-container">
                            <div id="edit-image-preview" class="image-preview"></div>
                            <button type="button" class="btn btn-outline" onclick="document.getElementById('edit-property-images').click()">
                                <i class="fas fa-upload"></i> رفع الصور
                            </button>
                            <input type="file" id="edit-property-images" class="form-control" multiple accept="image/*" style="display: none;">
                        </div>
                        <small>يمكنك رفع ما يصل إلى 5 صور</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">تحديث العقار</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add Agent Modal -->
    <div id="add-agent-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة وكيل جديد</h3>
                <button class="close-btn" onclick="closeModal('add-agent-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-agent-form">
                    <div class="form-group">
                        <label for="agent-name">الاسم</label>
                        <input type="text" id="agent-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agent-phone">رقم الهاتف</label>
                        <input type="tel" id="agent-phone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agent-email">البريد الإلكتروني</label>
                        <input type="email" id="agent-email" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">إضافة الوكيل</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Agent Modal -->
    <div id="edit-agent-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل الوكيل</h3>
                <button class="close-btn" onclick="closeModal('edit-agent-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-agent-form">
                    <input type="hidden" id="edit-agent-id">
                    
                    <div class="form-group">
                        <label for="edit-agent-name">الاسم</label>
                        <input type="text" id="edit-agent-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-agent-phone">رقم الهاتف</label>
                        <input type="tel" id="edit-agent-phone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-agent-email">البريد الإلكتروني</label>
                        <input type="email" id="edit-agent-email" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">تحديث الوكيل</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Declare supabase in the global scope
        let supabase;

        const supabaseUrl = 'https://oanuujxhmxngstijciie.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hbnV1anhobXhuZ3N0aWpjaWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDc2NjAsImV4cCI6MjA3NDAyMzY2MH0.kiv8JpUxtTdDwDJTsMoDTb2vYNWbQMH19lzfYv7Xdzs';

        // Function to create profiles table if it doesn't exist
        async function ensureProfilesTable() {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                // Check if profiles table exists by trying to select from it
                const { error } = await supabase
                    .from('profiles')
                    .select('count', { count: 'exact', head: true });
                    
                if (error) {
                    console.error('Profiles table may not exist, error:', error);
                    
                    // Try to create the table via RPC call
                    const { error: createError } = await supabase.rpc('create_profiles_table');
                    
                    if (createError) {
                        console.error('Error creating profiles table:', createError);
                    } else {
                        console.log('Profiles table created successfully');
                    }
                } else {
                    console.log('Profiles table exists');
                }
            } catch (err) {
                console.error('Error ensuring profiles table:', err);
            }
        }

        // Initialize Supabase when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase client
            if (window.supabase) {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                // Ensure profiles table exists
                await ensureProfilesTable();
                
                // Check if user is already logged in
                await checkUserSession();
                
                // Load home page properties
                loadHomePageProperties();
            } else {
                console.error('Supabase library not loaded');
                
                // Try to load the Supabase library dynamically
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js';
                script.onload = async () => {
                    console.log('Supabase library loaded dynamically');
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    
                    // Ensure profiles table exists
                    await ensureProfilesTable();
                    
                    // Check if user is already logged in
                    await checkUserSession();
                    
                    // Load home page properties
                    loadHomePageProperties();
                };
                script.onerror = () => {
                    console.error('Failed to load Supabase library dynamically');
                };
                document.head.appendChild(script);
            }
        });

        // Track current listing type
        let currentListingType = 'sale';
        let phoneNumberVisible = false;
        let currentPropertyId = null;
        let currentUser = null;
        let userProfile = null;
        let uploadedImages = [];
        let editUploadedImages = [];

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Function to get user profile from database
        async function getUserProfile(userId) {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return null;
            }
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .maybeSingle(); // Use maybeSingle instead of single to avoid error if not found
                
                if (error) {
                    console.error('Error fetching user profile:', error);
                    return null;
                }
                
                return data;
            } catch (err) {
                console.error('Error in getUserProfile:', err);
                return null;
            }
        }

        // Function to update user UI with profile data
        async function updateUserUI(user) {
            if (!user) {
                document.getElementById('auth-buttons').style.display = 'flex';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('dashboard-link').style.display = 'none';
                return;
            }

            // Get user profile from database
            userProfile = await getUserProfile(user.id);
            
            let displayName;
            if (userProfile && userProfile.full_name) {
                displayName = userProfile.full_name;
            } else {
                // Fallback to user metadata or email
                displayName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'مستخدم';
            }

            document.getElementById('auth-buttons').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('user-name').textContent = `مرحباً، ${displayName}`;
            
            // Show dashboard link if user is an owner
            if (userProfile && userProfile.role === 'owner') {
                document.getElementById('dashboard-link').style.display = 'block';
            } else {
                document.getElementById('dashboard-link').style.display = 'none';
            }
        }

        // Check if user is already logged in
        async function checkUserSession() {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (session) {
                    // User is logged in
                    currentUser = session.user;
                    
                    // Get user profile
                    userProfile = await getUserProfile(currentUser.id);
                    
                    // Update UI
                    await updateUserUI(currentUser);
                    
                    // Ensure user has a profile
                    await ensureUserProfile(currentUser);
                }
            } catch (err) {
                console.error('Error checking user session:', err);
            }
        }

        // Function to ensure user has a profile
        async function ensureUserProfile(user) {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                // Check if profile exists
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('id')
                    .eq('id', user.id)
                    .maybeSingle(); // Use maybeSingle instead of single
                
                // If profile doesn't exist, create it
                if (!profile || profileError) {
                    const fullName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'مستخدم';
                    
                    const { error: insertError } = await supabase
                        .from('profiles')
                        .insert([
                            { 
                                id: user.id, 
                                full_name: fullName, 
                                email: user.email,
                                role: 'user' // Default role is 'user'
                            }
                        ]);
                    
                    if (insertError) {
                        console.error('Error creating profile:', insertError);
                        
                        // If there's still an error, try to create a minimal profile
                        try {
                            const { error: minimalError } = await supabase
                                .from('profiles')
                                .insert([
                                    { 
                                        id: user.id
                                    }
                                ]);
                            
                            if (minimalError) {
                                console.error('Error creating minimal profile:', minimalError);
                            } else {
                                console.log('Created minimal profile successfully');
                            }
                        } catch (minimalErr) {
                            console.error('Error creating minimal profile:', minimalErr);
                        }
                    } else {
                        console.log('Profile created successfully');
                    }
                } else {
                    console.log('Profile already exists');
                }
            } catch (err) {
                console.error('Error ensuring user profile:', err);
            }
        }

        // Function to resend confirmation email
        async function resendConfirmationEmail(email) {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return false;
            }
            
            try {
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: email,
                });
                
                if (error) {
                    console.error('Error resending confirmation email:', error);
                    return false;
                }
                
                return true;
            } catch (err) {
                console.error('Error:', err);
                return false;
            }
        }

        // Registration function
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            
            if (password !== confirmPassword) {
                alert('كلمتا المرور غير متطابقتين');
                return;
            }
            
            try {
                // Register user
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });
                
                if (error) {
                    alert('خطأ في التسجيل: ' + error.message);
                    return;
                }
                
                // Create user profile in the database
                if (data.user) {
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert([
                            { 
                                id: data.user.id, 
                                full_name: name, 
                                email: email,
                                role: 'user' // Default role is 'user'
                            }
                        ]);
                        
                    if (profileError) {
                        console.error('Error creating profile:', profileError);
                    }
                }
                
                alert('تم إنشاء الحساب بنجاح! يرجى تفعيل حسابك عبر البريد الإلكتروني.');
                closeModal('register-modal');
                document.getElementById('register-form').reset();
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        });

        // Login function
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    if (error.message === "Email not confirmed") {
                        // Email not confirmed, show option to resend confirmation email
                        const resendOption = confirm("بريدك الإلكتروني لم يتم تأكيده بعد. هل ترغب في إعادة إرسال رسالة التأكيد؟");
                        if (resendOption) {
                            const success = await resendConfirmationEmail(email);
                            if (success) {
                                alert("تم إعادة إرسال رسالة التأكيد إلى بريدك الإلكتروني. يرجى التحقق من بريدك الوارد.");
                            } else {
                                alert("حدث خطأ أثناء إعادة إرسال رسالة التأكيد. يرجى المحاولة مرة أخرى لاحقاً.");
                            }
                        }
                        return;
                    } else {
                        alert('خطأ في تسجيل الدخول: ' + error.message);
                        return;
                    }
                }
                
                // Check if email is confirmed
                if (data.user && !data.user.email_confirmed_at) {
                    const resendOption = confirm("بريدك الإلكتروني لم يتم تأكيده بعد. هل ترغب في إعادة إرسال رسالة التأكيد؟");
                    if (resendOption) {
                        const success = await resendConfirmationEmail(email);
                        if (success) {
                            alert("تم إعادة إرسال رسالة التأكيد إلى بريدك الإلكتروني. يرجى التحقق من بريدك الوارد.");
                        } else {
                            alert("حدث خطأ أثناء إعادة إرسال رسالة التأكيد. يرجى المحاولة مرة أخرى لاحقاً.");
                        }
                    }
                    return;
                }
                
                // Update UI
                currentUser = data.user;
                await updateUserUI(currentUser);
                
                // Ensure user has a profile
                await ensureUserProfile(currentUser);
                
                closeModal('login-modal');
                document.getElementById('login-form').reset();
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        });

        // Logout function
        async function logout() {
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    alert('خطأ في تسجيل الخروج: ' + error.message);
                    return;
                }
                
                // Update UI
                currentUser = null;
                userProfile = null;
                await updateUserUI(null);
                
                alert('تم تسجيل الخروج بنجاح');
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to add property to favorites
        async function addToFavorites(propertyId) {
            // Check if user is logged in
            if (!currentUser) {
                alert('يرجى تسجيل الدخول لحفظ العقارات المفضلة');
                showModal('login-modal');
                return;
            }
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                // Ensure user has a profile before adding to favorites
                await ensureUserProfile(currentUser);
                
                const { error } = await supabase
                    .from('favorites')
                    .insert([
                        { user_id: currentUser.id, property_id: propertyId }
                    ]);
                    
                if (error) {
                    // Check if it's a duplicate entry
                    if (error.code === '23505') {
                        alert('العقار موجود بالفعل في قائمتك المفضلة');
                    } else {
                        console.error('Error adding to favorites:', error);
                        alert('خطأ في إضافة العقار للمفضلة: ' + error.message);
                    }
                    return;
                }
                
                alert('تم إضافة العقار إلى قائمتك المفضلة');
                updateFavoriteButton(propertyId, true);
            } catch (err) {
                console.error('Error in addToFavorites:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to remove property from favorites
        async function removeFromFavorites(propertyId) {
            // Check if user is logged in
            if (!currentUser) {
                return;
            }
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('favorites')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('property_id', propertyId);
                    
                if (error) {
                    alert('خطأ في إزالة العقار من المفضلة: ' + error.message);
                    return;
                }
                
                alert('تم إزالة العقار من قائمتك المفضلة');
                updateFavoriteButton(propertyId, false);
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to check if property is in user's favorites
        async function checkIfFavorite(propertyId) {
            if (!currentUser || !supabase) {
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('favorites')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('property_id', propertyId)
                    .maybeSingle(); // Use maybeSingle instead of single to avoid error if not found
                    
                if (error) {
                    console.error('Error checking favorite:', error);
                    return false;
                }
                
                return !!data;
            } catch (err) {
                console.error('Error:', err);
                return false;
            }
        }

        // Function to update favorite button state
        function updateFavoriteButton(propertyId, isFavorite) {
            const favoriteButtons = document.querySelectorAll(`[data-property-id="${propertyId}"] .btn-favorite`);
            const detailFavoriteBtn = document.getElementById('detail-favorite-btn');
            
            favoriteButtons.forEach(button => {
                if (isFavorite) {
                    button.innerHTML = '<i class="fas fa-heart"></i> إزالة من المفضلة';
                    button.classList.add('active');
                    button.onclick = () => removeFromFavorites(propertyId);
                } else {
                    button.innerHTML = '<i class="fas fa-heart"></i> حفظ العقار';
                    button.classList.remove('active');
                    button.onclick = () => addToFavorites(propertyId);
                }
            });
            
            // Update detail page button if it exists
            if (detailFavoriteBtn && currentPropertyId === propertyId) {
                if (isFavorite) {
                    detailFavoriteBtn.innerHTML = '<i class="fas fa-heart"></i> إزالة من المفضلة';
                    detailFavoriteBtn.classList.add('active');
                    detailFavoriteBtn.onclick = () => removeFromFavorites(propertyId);
                } else {
                    detailFavoriteBtn.innerHTML = '<i class="fas fa-heart"></i> حفظ العقار';
                    detailFavoriteBtn.classList.remove('active');
                    detailFavoriteBtn.onclick = () => addToFavorites(propertyId);
                }
            }
        }

        // Function to show user's favorite properties
        async function showFavorites() {
            if (!currentUser) {
                alert('يرجى تسجيل الدخول لعرض عقاراتك المفضلة');
                showModal('login-modal');
                return;
            }
            
            // Hide other pages
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none';
            
            // Show favorites page
            document.getElementById('favorites-page').style.display = 'block';
            
            // Update breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
                <li>عقاراتي المفضلة</li>
            `;
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                // Get user's favorites with property details
                const { data, error } = await supabase
                    .from('favorites')
                    .select(`
                        id,
                        property_id,
                        properties (
                            id,
                            title,
                            price,
                            type,
                            area,
                            bedrooms,
                            bathrooms,
                            city,
                            district,
                            image_urls,
                            property_type
                        )
                    `)
                    .eq('user_id', currentUser.id);
                    
                if (error) {
                    alert('خطأ في جلب العقارات المفضلة: ' + error.message);
                    return;
                }
                
                const favoritesGrid = document.getElementById('favorites-grid');
                favoritesGrid.innerHTML = '';
                
                if (!data || data.length === 0) {
                    favoritesGrid.innerHTML = `
                        <div class="no-results" style="grid-column: 1/-1;">
                            <i class="fas fa-heart"></i>
                            <h3>لا توجد عقارات مفضلة</h3>
                            <p>لم تقم بحفظ أي عقار في قائمتك المفضلة بعد.</p>
                            <button class="btn btn-primary" onclick="showHomePage()" style="margin-top: 15px;">
                                تصفح العقارات
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Display favorite properties
                data.forEach(fav => {
                    if (!fav.properties) return; // Skip if property data is missing
                    
                    const property = fav.properties;
                    const imageUrl = property.image_urls && property.image_urls.length > 0 
                        ? property.image_urls[0] 
                        : 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80';
                    
                    const propertyCard = document.createElement('div');
                    propertyCard.className = 'property-card';
                    propertyCard.setAttribute('data-property-id', property.id);
                    propertyCard.innerHTML = `
                        <div class="property-image">
                            <img src="${imageUrl}" alt="${property.title}">
                            <div class="property-badge badge-${property.type}">${property.type === 'sale' ? 'للبيع' : 'للإيجار'}</div>
                        </div>
                        <div class="property-content">
                            <h3 class="property-card-title">${property.title}</h3>
                            <div class="property-card-price price-${property.type}">
                                ${property.price.toLocaleString()} ريال ${property.type === 'rent' ? '/ شهرياً' : ''}
                            </div>
                            <div class="property-card-address">
                                <i class="fas fa-map-marker-alt"></i>
                                ${property.district}، ${property.city}
                            </div>
                            <div class="property-card-features">
                                <div class="property-feature">
                                    <i class="fas fa-ruler-combined"></i>
                                    <span>${property.area} م²</span>
                                </div>
                                ${property.bedrooms ? `
                                <div class="property-feature">
                                    <i class="fas fa-bed"></i>
                                    <span>${property.bedrooms} غرف</span>
                                </div>
                                ` : ''}
                                ${property.bathrooms ? `
                                <div class="property-feature">
                                    <i class="fas fa-bath"></i>
                                    <span>${property.bathrooms} حمامات</span>
                                </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="view-details-btn" onclick="showPropertyDetails('${property.id}', '${property.type}')" style="flex: 1;">
                                    عرض التفاصيل
                                </button>
                                <button class="btn-favorite active" onclick="removeFromFavorites('${property.id}')" style="width: auto; padding: 10px 15px;">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    favoritesGrid.appendChild(propertyCard);
                });
            } catch (err) {
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to fetch properties from Supabase
        async function fetchProperties(type = null) {
            console.log('Fetching properties with type:', type);
            
            if (!supabase) {
                console.error('Supabase client not initialized');
                return [];
            }
            
            try {
                let query = supabase.from('properties').select('*');
                
                if (type) {
                    query = query.eq('type', type);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('Error fetching properties:', error);
                    return [];
                }
                
                console.log('Fetched properties:', data);
                return data || [];
            } catch (err) {
                console.error('Error in fetchProperties:', err);
                return [];
            }
        }

        // Function to create property card HTML
        function createPropertyCard(property) {
            const imageUrl = property.image_urls && property.image_urls.length > 0 
                ? property.image_urls[0] 
                : 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80';
            
            const propertyCard = document.createElement('div');
            propertyCard.className = 'property-card';
            propertyCard.setAttribute('data-property-id', property.id);
            propertyCard.setAttribute('data-property-type', property.type); // Add this line
            propertyCard.innerHTML = `
                <div class="property-image">
                    <img src="${imageUrl}" alt="${property.title}">
                    <div class="property-badge badge-${property.type}">${property.type === 'sale' ? 'للبيع' : 'للإيجار'}</div>
                </div>
                <div class="property-content">
                    <h3 class="property-card-title">${property.title}</h3>
                    <div class="property-card-price price-${property.type}">
                        ${property.price.toLocaleString()} ريال ${property.type === 'rent' ? '/ شهرياً' : ''}
                    </div>
                    <div class="property-card-address">
                        <i class="fas fa-map-marker-alt"></i>
                        ${property.district}، ${property.city}
                    </div>
                    <div class="property-card-features">
                        <div class="property-feature">
                            <i class="fas fa-ruler-combined"></i>
                            <span>${property.area} م²</span>
                        </div>
                        ${property.bedrooms ? `
                        <div class="property-feature">
                            <i class="fas fa-bed"></i>
                            <span>${property.bedrooms} غرف</span>
                        </div>
                        ` : ''}
                        ${property.bathrooms ? `
                        <div class="property-feature">
                            <i class="fas fa-bath"></i>
                            <span>${property.bathrooms} حمامات</span>
                        </div>
                        ` : ''}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="view-details-btn" onclick="showPropertyDetails('${property.id}', '${property.type}')" style="flex: 1;">
                            عرض التفاصيل
                        </button>
                        <button class="btn-favorite" onclick="addToFavorites('${property.id}')" style="width: auto; padding: 10px 15px;">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return propertyCard;
        }

        // Function to show home page
        function showHomePage() {
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none'; // Hide dashboard
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            // Reset breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
            `;
            
            // Load properties
            loadHomePageProperties();
        }

        // Function to load properties for home page
        async function loadHomePageProperties() {
            const propertiesGrid = document.getElementById('home-properties-grid');
            propertiesGrid.innerHTML = '';
            
            // Fetch properties from Supabase
            const properties = await fetchProperties();
            
            // Display properties
            if (properties.length === 0) {
                propertiesGrid.innerHTML = `
                    <div class="no-properties" style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <i class="fas fa-home" style="font-size: 48px; color: #3498db; margin-bottom: 20px;"></i>
                        <h3>لا توجد عقارات متاحة</h3>
                        <p>لم يتم العثور على أي عقارات. يرجى إضافة بيانات تجريبية.</p>
                        <button class="btn btn-primary" onclick="insertSampleData()" style="margin-top: 15px;">
                            إضافة بيانات تجريبية
                        </button>
                    </div>
                `;
                return;
            }
            
            properties.forEach(property => {
                const propertyCard = createPropertyCard(property);
                propertiesGrid.appendChild(propertyCard);
            });
        }

        // Function to show properties listing (for sale)
        async function showPropertiesListing() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'block';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            currentListingType = 'sale';
            
            // Update breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
                <li><a onclick="showPropertiesListing()">عقارات للبيع</a></li>
            `;
            
            // Load properties
            const propertiesGrid = document.getElementById('sale-properties-grid');
            propertiesGrid.innerHTML = '';
            
            // Fetch properties from Supabase
            const properties = await fetchProperties('sale');
            
            // Display properties
            properties.forEach(property => {
                const propertyCard = createPropertyCard(property);
                propertiesGrid.appendChild(propertyCard);
            });
        }

        // Function to show rent properties listing
        async function showRentListing() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'block';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            currentListingType = 'rent';
            
            // Update breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
                <li><a onclick="showRentListing()">عقارات للإيجار</a></li>
            `;
            
            // Load properties
            const propertiesGrid = document.getElementById('rent-properties-grid');
            propertiesGrid.innerHTML = '';
            
            // Fetch properties from Supabase
            const properties = await fetchProperties('rent');
            
            // Display properties
            properties.forEach(property => {
                const propertyCard = createPropertyCard(property);
                propertiesGrid.appendChild(propertyCard);
            });
        }

        // Function to show contact page
        function showContactPage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'block';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            // Update breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
                <li><a onclick="showContactPage()">اتصل بنا</a></li>
            `;
            
            // Initialize contact map
            initContactMap();
        }

        // Function to filter properties on home page
        function filterProperties(type) {
            const tabs = document.querySelectorAll('.category-tab');
            const properties = document.querySelectorAll('#home-properties-grid .property-card');
            
            // Update active tab
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide properties based on filter
            properties.forEach(property => {
                const propertyType = property.getAttribute('data-property-type');
                if (type === 'all' || propertyType === type) {
                    property.style.display = 'block';
                } else {
                    property.style.display = 'none';
                }
            });
        }

        // Function to perform search on home page
        async function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('search-results').style.display = 'none';
                return;
            }
            
            // Fetch properties from Supabase
            const properties = await fetchProperties();
            const resultsContainer = document.getElementById('search-results-container');
            resultsContainer.innerHTML = '';
            
            let foundResults = false;
            
            properties.forEach(property => {
                const title = property.title.toLowerCase();
                const address = `${property.district}، ${property.city}`.toLowerCase();
                const propertyType = (property.property_type || '').toLowerCase();
                
                // Check if search term matches any property attribute
                if (title.includes(searchTerm) || 
                    address.includes(searchTerm) || 
                    propertyType.includes(searchTerm)) {
                    
                    // Create property card and add to results
                    const propertyCard = createPropertyCard(property);
                    resultsContainer.appendChild(propertyCard);
                    foundResults = true;
                }
            });
            
            // Show search results section
            document.getElementById('search-results').style.display = 'block';
            
            // Show no results message if no properties found
            if (!foundResults) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد نتائج</h3>
                        <p>لم يتم العثور على عقارات تطابق بحثك. يرجى تجربة كلمات أخرى.</p>
                    </div>
                `;
            }
            
            // Scroll to search results
            document.getElementById('search-results').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to perform search on sale properties page
        async function performSaleSearch() {
            const searchTerm = document.getElementById('sale-search-input').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('sale-search-results').style.display = 'none';
                // Show all properties if search term is empty
                showPropertiesListing();
                return;
            }
            
            // Fetch properties from Supabase
            const properties = await fetchProperties('sale');
            const resultsContainer = document.getElementById('sale-search-results-container');
            resultsContainer.innerHTML = '';
            
            let foundResults = false;
            
            properties.forEach(property => {
                const title = property.title.toLowerCase();
                const address = `${property.district}، ${property.city}`.toLowerCase();
                const propertyType = (property.property_type || '').toLowerCase();
                
                // Check if search term matches any property attribute
                if (title.includes(searchTerm) || 
                    address.includes(searchTerm) || 
                    propertyType.includes(searchTerm)) {
                    
                    // Create property card and add to results
                    const propertyCard = createPropertyCard(property);
                    resultsContainer.appendChild(propertyCard);
                    foundResults = true;
                }
            });
            
            // Show search results section
            document.getElementById('sale-search-results').style.display = 'block';
            
            // Show no results message if no properties found
            if (!foundResults) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد نتائج</h3>
                        <p>لم يتم العثور على عقارات تطابق بحثك. يرجى تجربة كلمات أخرى.</p>
                    </div>
                `;
            }
            
            // Scroll to search results
            document.getElementById('sale-search-results').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to perform search on rent properties page
        async function performRentSearch() {
            const searchTerm = document.getElementById('rent-search-input').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                document.getElementById('rent-search-results').style.display = 'none';
                // Show all properties if search term is empty
                showRentListing();
                return;
            }
            
            // Fetch properties from Supabase
            const properties = await fetchProperties('rent');
            const resultsContainer = document.getElementById('rent-search-results-container');
            resultsContainer.innerHTML = '';
            
            let foundResults = false;
            
            properties.forEach(property => {
                const title = property.title.toLowerCase();
                const address = `${property.district}، ${property.city}`.toLowerCase();
                const propertyType = (property.property_type || '').toLowerCase();
                
                // Check if search term matches any property attribute
                if (title.includes(searchTerm) || 
                    address.includes(searchTerm) || 
                    propertyType.includes(searchTerm)) {
                    
                    // Create property card and add to results
                    const propertyCard = createPropertyCard(property);
                    resultsContainer.appendChild(propertyCard);
                    foundResults = true;
                }
            });
            
            // Show search results section
            document.getElementById('rent-search-results').style.display = 'block';
            
            // Show no results message if no properties found
            if (!foundResults) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد نتائج</h3>
                        <p>لم يتم العثور على عقارات تطابق بحثك. يرجى تجربة كلمات أخرى.</p>
                    </div>
                `;
            }
            
            // Scroll to search results
            document.getElementById('rent-search-results').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to show property details and hide listing
        async function showPropertyDetails(propertyId, propertyType) {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'block';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('owner-dashboard').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            currentPropertyId = propertyId;
            currentPropertyType = propertyType;
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            // Fetch property from Supabase
            const { data: property, error } = await supabase
                .from('properties')
                .select('*')
                .eq('id', propertyId)
                .maybeSingle(); // Use maybeSingle instead of single to avoid error if not found
                
            if (error || !property) {
                console.error('Error fetching property:', error || 'Property not found');
                alert('عذراً، لم يتم العثور على العقار المطلوب');
                goBackToListing();
                return;
            }
            
            // Update property details
            document.getElementById('detail-title').textContent = property.title;
            document.getElementById('detail-price').textContent = `${property.price.toLocaleString()} ريال ${property.type === 'rent' ? '/ شهرياً' : ''}`;
            document.getElementById('detail-address').textContent = `${property.district}، ${property.city}، المملكة العربية السعودية`;
            document.getElementById('detail-description').textContent = property.description || 'لا يوجد وصف متاح';
            
            // Update owner information
            document.getElementById('owner-name').textContent = property.owner_name || 'غير محدد';
            document.getElementById('owner-phone').textContent = property.owner_phone || 'غير متوفر';
            document.getElementById('owner-email').textContent = property.owner_email || 'غير متوفر';
            document.getElementById('owner-avatar-img').src = property.owner_avatar || 'https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80';
            
            // Reset phone number visibility
            phoneNumberVisible = false;
            document.getElementById('owner-phone').style.filter = 'blur(4px)';
            document.getElementById('owner-phone').style.userSelect = 'none';
            
            // Update badge
            const badgeElement = document.getElementById('detail-badge');
            if (propertyType === 'sale') {
                badgeElement.textContent = 'للبيع';
                badgeElement.className = 'image-badge badge-sale-detail';
                document.getElementById('detail-price').className = 'property-price price-sale-detail';
                document.getElementById('request-type-text').textContent = 'شراء';
            } else {
                badgeElement.textContent = 'للإيجار';
                badgeElement.className = 'image-badge badge-rent-detail';
                document.getElementById('detail-price').className = 'property-price price-rent-detail';
                document.getElementById('request-type-text').textContent = 'إيجار';
            }
            
            // Update property features
            const featuresContainer = document.querySelector('.property-features');
            featuresContainer.innerHTML = `
                <div class="feature">
                    <i class="fas fa-ruler-combined"></i>
                    <div>
                        <span class="feature-value">${property.area} م²</span>
                        <span class="feature-label">المساحة</span>
                    </div>
                </div>
                ${property.bedrooms ? `
                <div class="feature">
                    <i class="fas fa-bed"></i>
                    <div>
                        <span class="feature-value">${property.bedrooms}</span>
                        <span class="feature-label">غرف نوم</span>
                    </div>
                </div>
                ` : ''}
                ${property.bathrooms ? `
                <div class="feature">
                    <i class="fas fa-bath"></i>
                    <div>
                        <span class="feature-value">${property.bathrooms}</span>
                        <span class="feature-label">حمامات</span>
                    </div>
                </div>
                ` : ''}
                ${property.parking ? `
                <div class="feature">
                    <i class="fas fa-car"></i>
                    <div>
                        <span class="feature-value">${property.parking}</span>
                        <span class="feature-label">مواقف سيارات</span>
                    </div>
                </div>
                ` : ''}
                ${property.floors ? `
                <div class="feature">
                    <i class="fas fa-building"></i>
                    <div>
                        <span class="feature-value">${property.floors}</span>
                        <span class="feature-label">عدد الأدوار</span>
                    </div>
                </div>
                ` : ''}
                ${property.year_built ? `
                <div class="feature">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <span class="feature-value">${property.year_built}</span>
                        <span class="feature-label">سنة البناء</span>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Update amenities
            const amenitiesContainer = document.querySelector('.amenities');
            amenitiesContainer.innerHTML = '';
            
            if (property.features && Array.isArray(property.features) && property.features.length > 0) {
                property.features.forEach(feature => {
                    const amenity = document.createElement('div');
                    amenity.className = 'amenity';
                    amenity.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span>${feature}</span>
                    `;
                    amenitiesContainer.appendChild(amenity);
                });
            } else {
                amenitiesContainer.innerHTML = '<p>لا توجد مرافق متوفرة</p>';
            }
            
            // Update gallery images
            const mainImage = document.getElementById('main-image');
            const thumbnails = document.querySelectorAll('.thumbnail img');
            
            if (property.image_urls && Array.isArray(property.image_urls) && property.image_urls.length > 0) {
                mainImage.src = property.image_urls[0];
                
                // Update thumbnails
                for (let i = 0; i < Math.min(3, property.image_urls.length); i++) {
                    if (thumbnails[i]) {
                        thumbnails[i].src = property.image_urls[i];
                        thumbnails[i].parentElement.setAttribute('onclick', `changeImage('${property.image_urls[i]}')`);
                    }
                }
            }
            
            // Check if property is in user's favorites
            const isFavorite = await checkIfFavorite(propertyId);
            updateFavoriteButton(propertyId, isFavorite);
            
            // Update breadcrumb
            if (propertyType === 'sale') {
                document.getElementById('breadcrumb-list').innerHTML = `
                    <li><a onclick="showHomePage()">الرئيسية</a></li>
                    <li><a onclick="showPropertiesListing()">عقارات للبيع</a></li>
                    <li>تفاصيل العقار</li>
                `;
            } else {
                document.getElementById('breadcrumb-list').innerHTML = `
                    <li><a onclick="showHomePage()">الرئيسية</a></li>
                    <li><a onclick="showRentListing()">عقارات للإيجار</a></li>
                    <li>تفاصيل العقار</li>
                `;
            }
            
            // Initialize map
            initMap();
        }

        // Function to go back to listing
        function goBackToListing() {
            if (currentListingType === 'sale') {
                showPropertiesListing();
            } else if (currentListingType === 'rent') {
                showRentListing();
            } else {
                showHomePage();
            }
        }

        // Function to change main image in gallery
        function changeImage(src) {
            document.getElementById('main-image').src = src;
        }

        // Function to show/hide phone number
        function showPhoneNumber() {
            const phoneElement = document.getElementById('owner-phone');
            if (!phoneNumberVisible) {
                phoneElement.style.filter = 'none';
                phoneElement.style.userSelect = 'text';
                phoneNumberVisible = true;
            }
        }

        // Function to open contact modal
        function openContactModal() {
            document.getElementById('contact-modal').style.display = 'flex';
        }

        // Function to close contact modal
        function closeContactModal() {
            document.getElementById('contact-modal').style.display = 'none';
        }

        // Initialize map for property details
        function initMap() {
            // Check if map container exists
            if (document.getElementById('property-map')) {
                // Create a map centered on Riyadh
                var map = L.map('property-map').setView([24.7136, 46.6753], 15);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Add a marker for the property
                L.marker([24.7136, 46.6753])
                    .addTo(map)
                    .bindPopup('عقار في الرياض')
                    .openPopup();
            }
        }

        // Initialize map for contact page
        function initContactMap() {
            // Check if map container exists
            if (document.getElementById('contact-map')) {
                // Create a map centered on Riyadh
                var map = L.map('contact-map').setView([24.7136, 46.6753], 13);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Add a marker for the office
                L.marker([24.7136, 46.6753])
                    .addTo(map)
                    .bindPopup('مكتب عقارك الرئيسي')
                    .openPopup();
            }
        }

        // Close modal if clicked outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Add event listener for Enter key on search inputs
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('sale-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSaleSearch();
            }
        });

        document.getElementById('rent-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performRentSearch();
            }
        });

        // Owner Dashboard Functions

        // Show owner dashboard
        async function showOwnerDashboard() {
            // Check if user is logged in
            if (!currentUser) {
                alert('يرجى تسجيل الدخول أولاً');
                showModal('login-modal');
                return;
            }
            
            // Check if user profile is loaded
            if (!userProfile) {
                userProfile = await getUserProfile(currentUser.id);
            }
            
            // Check if user is an owner
            if (!userProfile || userProfile.role !== 'owner') {
                alert('لا تملك صلاحية الوصول إلى لوحة التحكم');
                showHomePage();
                return;
            }
            
            // Hide other pages
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('properties-listing').style.display = 'none';
            document.getElementById('rent-listing').style.display = 'none';
            document.getElementById('property-detail').style.display = 'none';
            document.getElementById('contact-page').style.display = 'none';
            document.getElementById('favorites-page').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('sale-search-results').style.display = 'none';
            document.getElementById('rent-search-results').style.display = 'none';
            
            // Show owner dashboard
            document.getElementById('owner-dashboard').style.display = 'block';
            
            // Update breadcrumb
            document.getElementById('breadcrumb-list').innerHTML = `
                <li><a onclick="showHomePage()">الرئيسية</a></li>
                <li>لوحة التحكم</li>
            `;
            
            // Load properties
            loadOwnerProperties();
            
            // Load agents
            loadOwnerAgents();
            
            // Load conversations
            loadConversations();
            
            // Load requests
            loadOwnerRequests();
            
            // Load reports
            loadOwnerReports();
        }

        // Show dashboard section
        function showDashboardSection(section) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar li').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(`dashboard-${section}`).style.display = 'block';
            
            // Add active class to clicked sidebar item
            event.target.closest('li').classList.add('active');
            
            // Load data for the section
            if (section === 'properties') {
                loadOwnerProperties();
            } else if (section === 'agents') {
                loadOwnerAgents();
            } else if (section === 'messages') {
                loadConversations();
            } else if (section === 'requests') {
                loadOwnerRequests();
            } else if (section === 'reports') {
                loadOwnerReports();
            }
        }

        // Load owner properties
        async function loadOwnerProperties() {
            const tbody = document.getElementById('properties-tbody');
            tbody.innerHTML = '';
            
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('properties')
                    .select('*')
                    .eq('owner_id', currentUser.id);
                    
                if (error) {
                    console.error('Error loading properties:', error);
                    return;
                }
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px;">
                                لا توجد عقارات مضافة بعد
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                data.forEach(property => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${property.title}</td>
                        <td>${property.price.toLocaleString()} ريال</td>
                        <td>${property.city}</td>
                        <td>
                            <span class="status-badge status-${property.status}">
                                ${property.status === 'available' ? 'متاح' : 'مباع'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="editProperty('${property.id}')">
                                    تعديل
                                </button>
                                <button class="btn btn-outline btn-small" onclick="togglePropertyStatus('${property.id}', '${property.status}')">
                                    ${property.status === 'available' ? 'تعيين كمباع' : 'تعيين كمتاح'}
                                </button>
                                <button class="btn btn-outline btn-small" onclick="deleteProperty('${property.id}')">
                                    حذف
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Show add property form
        function showAddPropertyForm() {
            showModal('add-property-modal');
        }

        // Image upload functionality
        document.getElementById('property-images').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('image-preview');
            
            // Clear previous previews
            preview.innerHTML = '';
            uploadedImages = [];
            
            // Add new previews
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    preview.appendChild(img);
                    uploadedImages.push(event.target.result);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // Edit image upload functionality
        document.getElementById('edit-property-images').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('edit-image-preview');
            
            // Clear previous previews
            preview.innerHTML = '';
            editUploadedImages = [];
            
            // Add new previews
            for (let i = 0; i < Math.min(files.length, 5); i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    preview.appendChild(img);
                    editUploadedImages.push(event.target.result);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // Add property form submission
        document.getElementById('add-property-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const propertyData = {
                title: document.getElementById('property-title').value,
                price: parseFloat(document.getElementById('property-price').value),
                city: document.getElementById('property-city').value,
                district: document.getElementById('property-district').value,
                area: parseInt(document.getElementById('property-area').value),
                bedrooms: parseInt(document.getElementById('property-bedrooms').value) || null,
                bathrooms: parseInt(document.getElementById('property-bathrooms').value) || null,
                description: document.getElementById('property-description').value,
                type: document.getElementById('property-type').value,
                status: document.getElementById('property-status').value,
                owner_id: currentUser.id,
                image_urls: uploadedImages.length > 0 ? uploadedImages : null
            };
            
            try {
                const { data, error } = await supabase
                    .from('properties')
                    .insert([propertyData]);
                    
                if (error) {
                    console.error('Error adding property:', error);
                    alert('خطأ في إضافة العقار: ' + error.message);
                    return;
                }
                
                // Success - close modal and reload properties
                closeModal('add-property-modal');
                loadOwnerProperties();
                alert('تم إضافة العقار بنجاح');
                
                // Reset form
                document.getElementById('add-property-form').reset();
                document.getElementById('image-preview').innerHTML = '';
                uploadedImages = [];
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        });

        // Function to edit a property
        async function editProperty(propertyId) {
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                // Fetch property data
                const { data: property, error } = await supabase
                    .from('properties')
                    .select('*')
                    .eq('id', propertyId)
                    .maybeSingle(); // Use maybeSingle instead of single
                    
                if (error) {
                    console.error('Error fetching property:', error);
                    alert('خطأ في جلب بيانات العقار');
                    return;
                }
                
                // Populate form with property data
                document.getElementById('edit-property-id').value = property.id;
                document.getElementById('edit-property-title').value = property.title;
                document.getElementById('edit-property-price').value = property.price;
                document.getElementById('edit-property-city').value = property.city;
                document.getElementById('edit-property-district').value = property.district;
                document.getElementById('edit-property-area').value = property.area;
                document.getElementById('edit-property-bedrooms').value = property.bedrooms || '';
                document.getElementById('edit-property-bathrooms').value = property.bathrooms || '';
                document.getElementById('edit-property-description').value = property.description || '';
                document.getElementById('edit-property-type').value = property.type;
                document.getElementById('edit-property-status').value = property.status;
                
                // Show edit modal
                showModal('edit-property-modal');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Edit property form submission
        document.getElementById('edit-property-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const propertyId = document.getElementById('edit-property-id').value;
            
            const propertyData = {
                title: document.getElementById('edit-property-title').value,
                price: parseFloat(document.getElementById('edit-property-price').value),
                city: document.getElementById('edit-property-city').value,
                district: document.getElementById('edit-property-district').value,
                area: parseInt(document.getElementById('edit-property-area').value),
                bedrooms: parseInt(document.getElementById('edit-property-bedrooms').value) || null,
                bathrooms: parseInt(document.getElementById('edit-property-bathrooms').value) || null,
                description: document.getElementById('edit-property-description').value,
                type: document.getElementById('edit-property-type').value,
                status: document.getElementById('edit-property-status').value
            };
            
            // Only update images if new ones were uploaded
            if (editUploadedImages.length > 0) {
                propertyData.image_urls = editUploadedImages;
            }
            
            try {
                const { error } = await supabase
                    .from('properties')
                    .update(propertyData)
                    .eq('id', propertyId);
                    
                if (error) {
                    console.error('Error updating property:', error);
                    alert('خطأ في تحديث العقار: ' + error.message);
                    return;
                }
                
                // Success - close modal and reload properties
                closeModal('edit-property-modal');
                loadOwnerProperties();
                alert('تم تحديث العقار بنجاح');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        });

        // Function to toggle property status
        async function togglePropertyStatus(propertyId, currentStatus) {
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const newStatus = currentStatus === 'available' ? 'sold' : 'available';
            
            try {
                const { error } = await supabase
                    .from('properties')
                    .update({ status: newStatus })
                    .eq('id', propertyId);
                    
                if (error) {
                    console.error('Error updating property status:', error);
                    alert('خطأ في تحديث حالة العقار: ' + error.message);
                    return;
                }
                
                // Reload properties
                loadOwnerProperties();
                alert(`تم تحديث حالة العقار إلى ${newStatus === 'available' ? 'متاح' : 'مباع'} بنجاح`);
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to delete a property
        async function deleteProperty(propertyId) {
            if (!confirm('هل أنت متأكد من حذف هذا العقار؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('properties')
                    .delete()
                    .eq('id', propertyId);
                    
                if (error) {
                    console.error('Error deleting property:', error);
                    alert('خطأ في حذف العقار: ' + error.message);
                    return;
                }
                
                // Reload properties
                loadOwnerProperties();
                alert('تم حذف العقار بنجاح');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to load owner agents
        async function loadOwnerAgents() {
            const tbody = document.getElementById('agents-tbody');
            tbody.innerHTML = '';
            
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .select('*')
                    .eq('owner_id', currentUser.id);
                    
                if (error) {
                    console.error('Error loading agents:', error);
                    return;
                }
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                لا توجد وكلاء مضافين بعد
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                data.forEach(agent => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${agent.name}</td>
                        <td>${agent.phone}</td>
                        <td>${agent.email}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="editAgent('${agent.id}')">
                                    تعديل
                                </button>
                                <button class="btn btn-outline btn-small" onclick="deleteAgent('${agent.id}')">
                                    حذف
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Function to edit an agent
        async function editAgent(agentId) {
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                // Fetch agent data
                const { data: agent, error } = await supabase
                    .from('agents')
                    .select('*')
                    .eq('id', agentId)
                    .maybeSingle(); // Use maybeSingle instead of single
                    
                if (error) {
                    console.error('Error fetching agent:', error);
                    alert('خطأ في جلب بيانات الوكيل');
                    return;
                }
                
                // Populate form with agent data
                document.getElementById('edit-agent-id').value = agent.id;
                document.getElementById('edit-agent-name').value = agent.name;
                document.getElementById('edit-agent-phone').value = agent.phone;
                document.getElementById('edit-agent-email').value = agent.email;
                
                // Show edit modal
                showModal('edit-agent-modal');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Edit agent form submission
        document.getElementById('edit-agent-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            const agentId = document.getElementById('edit-agent-id').value;
            
            const agentData = {
                name: document.getElementById('edit-agent-name').value,
                phone: document.getElementById('edit-agent-phone').value,
                email: document.getElementById('edit-agent-email').value
            };
            
            try {
                const { error } = await supabase
                    .from('agents')
                    .update(agentData)
                    .eq('id', agentId);
                    
                if (error) {
                    console.error('Error updating agent:', error);
                    alert('خطأ في تحديث الوكيل: ' + error.message);
                    return;
                }
                
                // Success - close modal and reload agents
                closeModal('edit-agent-modal');
                loadOwnerAgents();
                alert('تم تحديث الوكيل بنجاح');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        });

        // Function to delete an agent
        async function deleteAgent(agentId) {
            if (!confirm('هل أنت متأكد من حذف هذا الوكيل؟')) {
                return;
            }
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('agents')
                    .delete()
                    .eq('id', agentId);
                    
                if (error) {
                    console.error('Error deleting agent:', error);
                    alert('خطأ في حذف الوكيل: ' + error.message);
                    return;
                }
                
                // Reload agents
                loadOwnerAgents();
                alert('تم حذف الوكيل بنجاح');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to load owner reports
        async function loadOwnerReports() {
            const reportsContainer = document.getElementById('reports-container');
            reportsContainer.innerHTML = '<div class="loading">جاري تحميل التقارير...</div>';
            
            if (!supabase) {
                reportsContainer.innerHTML = '<div class="error">الخدمة غير متوفرة حالياً</div>';
                return;
            }
            
            try {
                // Get properties count
                const { data: properties, error: propertiesError } = await supabase
                    .from('properties')
                    .select('*')
                    .eq('owner_id', currentUser.id);
                    
                if (propertiesError) {
                    console.error('Error loading properties:', propertiesError);
                    reportsContainer.innerHTML = '<div class="error">خطأ في تحميل البيانات</div>';
                    return;
                }
                
                // Get favorites count
                const { data: favorites, error: favoritesError } = await supabase
                    .from('favorites')
                    .select(`
                        property_id,
                        properties (
                            id,
                            title
                        )
                    `)
                    .in('property_id', properties.map(p => p.id));
                    
                if (favoritesError) {
                    console.error('Error loading favorites:', favoritesError);
                }
                
                // Calculate statistics
                const totalProperties = properties ? properties.length : 0;
                const availableProperties = properties ? properties.filter(p => p.status === 'available').length : 0;
                const soldProperties = properties ? properties.filter(p => p.status === 'sold').length : 0;
                const totalFavorites = favorites ? favorites.length : 0;
                
                // Calculate total value
                const totalValue = properties ? properties.reduce((sum, p) => sum + p.price, 0) : 0;
                
                // Create report HTML
                reportsContainer.innerHTML = `
                    <div class="reports-grid">
                        <div class="report-card">
                            <h3>إجمالي العقارات</h3>
                            <div class="report-value">${totalProperties}</div>
                        </div>
                        <div class="report-card">
                            <h3>العقارات المتاحة</h3>
                            <div class="report-value">${availableProperties}</div>
                        </div>
                        <div class="report-card">
                            <h3>العقارات المباعة</h3>
                            <div class="report-value">${soldProperties}</div>
                        </div>
                        <div class="report-card">
                            <h3>القيمة الإجمالية</h3>
                            <div class="report-value">${totalValue.toLocaleString()} ريال</div>
                        </div>
                        <div class="report-card">
                            <h3>الإضافات للمفضلة</h3>
                            <div class="report-value">${totalFavorites}</div>
                        </div>
                    </div>
                    
                    <div class="report-details">
                        <h3>تفاصيل العقارات</h3>
                        <div class="report-table-container">
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>العقار</th>
                                        <th>الحالة</th>
                                        <th>السعر</th>
                                        <th>المدينة</th>
                                        <th>الإضافات للمفضلة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${properties && properties.length > 0 ? properties.map(property => {
                                        const propertyFavorites = favorites ? favorites.filter(f => f.property_id === property.id).length : 0;
                                        return `
                                            <tr>
                                                <td>${property.title}</td>
                                                <td>
                                                    <span class="status-badge status-${property.status}">
                                                        ${property.status === 'available' ? 'متاح' : 'مباع'}
                                                    </span>
                                                </td>
                                                <td>${property.price.toLocaleString()} ريال</td>
                                                <td>${property.city}</td>
                                                <td>${propertyFavorites}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="5" style="text-align: center;">لا توجد بيانات</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Error:', err);
                reportsContainer.innerHTML = '<div class="error">حدث خطأ في تحميل التقارير</div>';
            }
        }

        // Function to load conversations
        async function loadConversations() {
            const conversationsContainer = document.getElementById('conversations-container');
            conversationsContainer.innerHTML = '<div class="loading">جاري تحميل المحادثات...</div>';
            
            if (!supabase) {
                conversationsContainer.innerHTML = '<div class="error">الخدمة غير متوفرة حالياً</div>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('conversations')
                    .select(`
                        *,
                        users (
                            full_name,
                            email
                        )
                    `)
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('Error loading conversations:', error);
                    conversationsContainer.innerHTML = '<div class="error">خطأ في تحميل المحادثات</div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    conversationsContainer.innerHTML = `
                        <div class="no-conversations">
                            <i class="fas fa-comments"></i>
                            <h3>لا توجد محادثات</h3>
                            <p>لم تتلق أي رسائل بعد.</p>
                        </div>
                    `;
                    return;
                }
                
                conversationsContainer.innerHTML = '';
                
                data.forEach(conversation => {
                    const conversationDiv = document.createElement('div');
                    conversationDiv.className = 'conversation';
                    conversationDiv.innerHTML = `
                        <div class="conversation-header">
                            <div class="conversation-user">
                                <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80" alt="${conversation.users.full_name}" class="conversation-avatar">
                                <div>
                                    <div class="conversation-name">${conversation.users.full_name}</div>
                                    <div class="conversation-email">${conversation.users.email}</div>
                                </div>
                            </div>
                            <div class="conversation-date">${new Date(conversation.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="conversation-message">
                            ${conversation.message}
                        </div>
                        <div class="conversation-actions">
                            <button class="btn btn-primary btn-small" onclick="viewConversation('${conversation.id}')">
                                عرض المحادثة
                            </button>
                            <button class="btn btn-outline btn-small" onclick="deleteConversation('${conversation.id}')">
                                حذف
                            </button>
                        </div>
                    `;
                    conversationsContainer.appendChild(conversationDiv);
                });
            } catch (err) {
                console.error('Error:', err);
                conversationsContainer.innerHTML = '<div class="error">حدث خطأ في تحميل المحادثات</div>';
            }
        }

        // Function to view conversation
        function viewConversation(conversationId) {
            alert(`عرض المحادثة: ${conversationId}`);
            // TODO: Implement view conversation functionality
        }

        // Function to delete conversation
        async function deleteConversation(conversationId) {
            if (!confirm('هل أنت متأكد من حذف هذه المحادثة؟')) {
                return;
            }
            
            if (!supabase) {
                alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('conversations')
                    .delete()
                    .eq('id', conversationId);
                    
                if (error) {
                    console.error('Error deleting conversation:', error);
                    alert('خطأ في حذف المحادثة: ' + error.message);
                    return;
                }
                
                // Reload conversations
                loadConversations();
                alert('تم حذف المحادثة بنجاح');
            } catch (err) {
                console.error('Error:', err);
                alert('حدث خطأ: ' + err.message);
            }
        }

        // Function to load owner requests
        async function loadOwnerRequests() {
            const requestsContainer = document.getElementById('requests-container');
            requestsContainer.innerHTML = '<div class="loading">جاري تحميل الطلبات...</div>';
            
            if (!supabase) {
                requestsContainer.innerHTML = '<div class="error">الخدمة غير متوفرة حالياً</div>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('property_requests')
                    .select(`
                        *,
                        properties (title, type),
                        users (full_name, email)
                    `)
                    .eq('owner_id', currentUser.id)
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('Error loading requests:', error);
                    requestsContainer.innerHTML = '<div class="error">خطأ في تحميل الطلبات</div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    requestsContainer.innerHTML = `
                        <div class="no-requests">
                            <i class="fas fa-handshake"></i>
                            <h3>لا توجد طلبات</h3>
                            <p>لم تتلق أي طلبات شراء أو إيجار بعد.</p>
                        </div>
                    `;
                    return;
                }
                
                requestsContainer.innerHTML = '';
                
                data.forEach(request => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'request-card';
                    requestDiv.innerHTML = `
                        <div class="request-header">
                            <div class="request-info">
                                <h4>${request.properties.title}</h4>
                                <div class="request-type">${request.type === 'sale' ? 'طلب شراء' : 'طلب إيجار'}</div>
                            </div>
                            <div class="request-status status-${request.status}">
                                ${request.status === 'pending' ? 'قيد الانتظار' : request.status === 'accepted' ? 'مقبول' : 'مرفوض'}
                            </div>
                        </div>
                        <div class="request-user">
                            <strong>من:</strong> ${request.users.full_name} (${request.users.email})
                        </div>
                        <div class="request-message">
                            <strong>الرسالة:</strong> ${request.message || 'لا توجد رسالة'}
                        </div>
                        ${request.offer ? `
                        <div class="request-offer">
                            <strong>العرض:</strong> ${request.offer.toLocaleString()} ريال
                        </div>
                        ` : ''}
                        <div class="request-date">
                            <strong>التاريخ:</strong> ${new Date(request.created_at).toLocaleString()}
                        </div>
                        ${request.status === 'pending' ? `
                        <div class="request-actions">
                            <button class="btn btn-success btn-small" onclick="updateRequestStatus('${request.id}', 'accepted')">
                                قبول
                            </button>
                            <button class="btn btn-danger btn-small" onclick="updateRequestStatus('${request.id}', 'rejected')">
                                رفض
                            </button>
                        </div>
                        ` : ''}
                    `;
                    requestsContainer.appendChild(requestDiv);
                });
            } catch (err) {
                console.error('Error:', err);
                requestsContainer.innerHTML = '<div class="error">حدث خطأ في تحميل الطلبات</div>';
            }
        }

        // Update request status
// دالة تحديث حالة الطلب
async function updateRequestStatus(requestId, status) {
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('property_requests')
            .update({ status: status })
            .eq('id', requestId);
            
        if (error) {
            console.error('Error updating request status:', error);
            alert('خطأ في تحديث حالة الطلب: ' + error.message);
            return;
        }
        
        // إعادة تحميل الطلبات
        loadOwnerRequests();
        alert(`تم ${status === 'accepted' ? 'قبول' : 'رفض'} الطلب بنجاح`);
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
}

// دالة إظهار نافذة الطلب
function showRequestModal() {
    if (!currentUser) {
        alert('يرجى تسجيل الدخول لإرسال طلب');
        showModal('login-modal');
        return;
    }
    
    // تعيين نص نوع الطلب حسب نوع العقار الحالي
    document.getElementById('request-type-text').textContent = currentPropertyType === 'sale' ? 'شراء' : 'إيجار';
    
    // إظهار النافذة
    showModal('request-modal');
}

// دالة إغلاق نافذة الطلب
function closeRequestModal() {
    closeModal('request-modal');
}

// دالة إضافة بيانات تجريبية
async function insertSampleData() {
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    try {
        // بيانات عقارات تجريبية
        const sampleProperties = [
            {
                title: 'فيلا فاخرة في حي النخيل',
                price: 2500000,
                city: 'الرياض',
                district: 'حي النخيل',
                area: 500,
                bedrooms: 5,
                bathrooms: 4,
                description: 'فيلا فاخرة جداً في حي النخيل، تتكون من دورين وملحق، تشطيب فاخر، حديقة واسعة، ومسبح.',
                type: 'sale',
                status: 'available',
                owner_id: currentUser ? currentUser.id : null,
                image_urls: [
                    'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                    'https://images.unsplash.com/photo-1570129477492-45c003edd2be?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
                ],
                features: ['مسبح', 'حديقة', 'غرفة خادمة', 'مواقف سيارات', 'تشطيب فاخر']
            },
            {
                title: 'شقة عصرية في حي الملز',
                price: 800000,
                city: 'الرياض',
                district: 'حي الملز',
                area: 180,
                bedrooms: 3,
                bathrooms: 2,
                description: 'شقة عصرية في حي الملز، تشطيب عالي الجودة، إطلالة جميلة، قريبة من جميع الخدمات.',
                type: 'sale',
                status: 'available',
                owner_id: currentUser ? currentUser.id : null,
                image_urls: [
                    'https://images.unsplash.com/photo-1556911220-e15b29be8c8f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
                ],
                features: ['تشطيب فاخر', 'مصعد', 'أمن', 'مواقف سيارات']
            },
            {
                title: 'شقة للإيجار في حي السليمانية',
                price: 45000,
                city: 'الرياض',
                district: 'حي السليمانية',
                area: 120,
                bedrooms: 2,
                bathrooms: 1,
                description: 'شقة جميلة للإيجار في حي السليمانية، قريبة من المرافق والخدمات.',
                type: 'rent',
                status: 'available',
                owner_id: currentUser ? currentUser.id : null,
                image_urls: [
                    'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
                ],
                features: ['مكيفات', 'مطبخ مجهز', 'أمن', 'مواقف سيارات']
            },
            {
                title: 'أرض سكنية في حي Yasmin',
                price: 1200000,
                city: 'الرياض',
                district: 'حي الياسمين',
                area: 600,
                description: 'أرض سكنية في حي الياسمين، موقع مميز، مناسبة للبناء.',
                type: 'sale',
                status: 'available',
                owner_id: currentUser ? currentUser.id : null,
                image_urls: [
                    'https://images.unsplash.com/photo-1502672260266-1c1ef2d73660?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
                ],
                features: ['موقع مميز', 'شوارع واسعة', 'خدمات متوفرة']
            }
        ];
        
        // إدخال العقارات التجريبية
        const { data, error } = await supabase
            .from('properties')
            .insert(sampleProperties);
            
        if (error) {
            console.error('Error inserting sample data:', error);
            alert('خطأ في إضافة البيانات التجريبية: ' + error.message);
            return;
        }
        
        alert('تمت إضافة البيانات التجريبية بنجاح');
        
        // إعادة تحميل الصفحة الحالية
        if (document.getElementById('home-page').style.display === 'block') {
            loadHomePageProperties();
        } else if (document.getElementById('properties-listing').style.display === 'block') {
            showPropertiesListing();
        } else if (document.getElementById('rent-listing').style.display === 'block') {
            showRentListing();
        }
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
}

// مستمعات الأحداث للنماذج

// نموذج الاتصال
document.getElementById('contact-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('contact-name').value;
    const email = document.getElementById('contact-email').value;
    const subject = document.getElementById('contact-subject').value;
    const message = document.getElementById('contact-message').value;
    
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('contact_messages')
            .insert([
                { name, email, subject, message }
            ]);
            
        if (error) {
            console.error('Error sending contact message:', error);
            alert('خطأ في إرسال الرسالة: ' + error.message);
            return;
        }
        
        alert('تم إرسال رسالتك بنجاح! سنتواصل معك قريباً.');
        document.getElementById('contact-form').reset();
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
});

// نموذج الاتصال في النافذة المنبثقة
document.getElementById('contact-modal-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentPropertyId) {
        alert('لم يتم تحديد العقار');
        return;
    }
    
    const name = document.getElementById('contact-modal-name').value;
    const phone = document.getElementById('contact-modal-phone').value;
    const email = document.getElementById('contact-modal-email').value;
    const message = document.getElementById('contact-modal-message').value;
    
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    try {
        // الحصول على تفاصيل العقار
        const { data: property, error: propertyError } = await supabase
            .from('properties')
            .select('owner_id')
            .eq('id', currentPropertyId)
            .maybeSingle();
            
        if (propertyError || !property) {
            console.error('Error fetching property:', propertyError || 'Property not found');
            alert('خطأ في جلب بيانات العقار');
            return;
        }
        
        // إدراج المحادثة
        const { data, error } = await supabase
            .from('conversations')
            .insert([
                { 
                    user_id: currentUser ? currentUser.id : null,
                    owner_id: property.owner_id,
                    property_id: currentPropertyId,
                    name,
                    phone,
                    email,
                    message
                }
            ]);
            
        if (error) {
            console.error('Error sending message:', error);
            alert('خطأ في إرسال الرسالة: ' + error.message);
            return;
        }
        
        alert('تم إرسال رسالتك بنجاح! سيتواصل معك المالك قريباً.');
        closeContactModal();
        document.getElementById('contact-modal-form').reset();
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
});

// نموذج الطلب
document.getElementById('request-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentPropertyId) {
        alert('لم يتم تحديد العقار');
        return;
    }
    
    const message = document.getElementById('request-message').value;
    const offer = document.getElementById('request-offer').value;
    const terms = document.getElementById('request-terms').checked;
    
    if (!terms) {
        alert('يجب الموافقة على الشروط والأحكام');
        return;
    }
    
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    try {
        // الحصول على تفاصيل العقار
        const { data: property, error: propertyError } = await supabase
            .from('properties')
            .select('owner_id, type')
            .eq('id', currentPropertyId)
            .maybeSingle();
            
        if (propertyError || !property) {
            console.error('Error fetching property:', propertyError || 'Property not found');
            alert('خطأ في جلب بيانات العقار');
            return;
        }
        
        // إدراج الطلب
        const requestData = {
            user_id: currentUser ? currentUser.id : null,
            owner_id: property.owner_id,
            property_id: currentPropertyId,
            type: property.type,
            message: message,
            status: 'pending'
        };
        
        if (offer) {
            requestData.offer = parseFloat(offer);
        }
        
        const { data, error } = await supabase
            .from('property_requests')
            .insert([requestData]);
            
        if (error) {
            console.error('Error sending request:', error);
            alert('خطأ في إرسال الطلب: ' + error.message);
            return;
        }
        
        alert('تم إرسال طلبك بنجاح! سيتم مراجعته من قبل المالك.');
        closeModal('request-modal');
        document.getElementById('request-form').reset();
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
});

// نموذج إضافة وكيل
document.getElementById('add-agent-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!supabase) {
        alert('الخدمة غير متوفرة حالياً. يرجى المحاولة مرة أخرى لاحقاً.');
        return;
    }
    
    const agentData = {
        name: document.getElementById('agent-name').value,
        phone: document.getElementById('agent-phone').value,
        email: document.getElementById('agent-email').value,
        owner_id: currentUser.id
    };
    
    try {
        const { data, error } = await supabase
            .from('agents')
            .insert([agentData]);
            
        if (error) {
            console.error('Error adding agent:', error);
            alert('خطأ في إضافة الوكيل: ' + error.message);
            return;
        }
        
        // النجاح - إغلاق النافذة وإعادة تحميل الوكلاء
        closeModal('add-agent-modal');
        loadOwnerAgents();
        alert('تم إضافة الوكيل بنجاح');
        
        // إعادة تعيين النموذج
        document.getElementById('add-agent-form').reset();
    } catch (err) {
        console.error('Error:', err);
        alert('حدث خطأ: ' + err.message);
    }
});

// دالة إظهار المفضلة
function showFavoritesPage() {
    // إخفاء الصفحات الأخرى
    document.getElementById('home-page').style.display = 'none';
    document.getElementById('properties-listing').style.display = 'none';
    document.getElementById('rent-listing').style.display = 'none';
    document.getElementById('property-detail').style.display = 'none';
    document.getElementById('contact-page').style.display = 'none';
    document.getElementById('owner-dashboard').style.display = 'none';
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('sale-search-results').style.display = 'none';
    document.getElementById('rent-search-results').style.display = 'none';
    
    // إظهار صفحة المفضلة
    document.getElementById('favorites-page').style.display = 'block';
    
    // تحديث مسار التنقل
    document.getElementById('breadcrumb-list').innerHTML = `
        <li><a onclick="showHomePage()">الرئيسية</a></li>
        <li>عقاراتي المفضلة</li>
    `;
    
    // تحميل العقارات المفضلة
    showFavorites();
}

// إضافة مستمع للنقر على رابط المفضلة في القائمة العلوية
document.addEventListener('DOMContentLoaded', function() {
    // إضافة رابط المفضلة للقائمة العلوية إذا كان المستخدم مسجلاً
    const nav = document.querySelector('nav ul');
    const favoritesLink = document.createElement('li');
    favoritesLink.innerHTML = '<a href="#" onclick="showFavoritesPage()">المفضلة</a>';
    favoritesLink.style.display = 'none'; // إخفاء بشكل افتراضي
    favoritesLink.id = 'favorites-link';
    nav.appendChild(favoritesLink);
    
    // تحديث واجهة المستخدم عند تحميل الصفحة
    checkUserSession().then(() => {
        if (currentUser) {
            document.getElementById('favorites-link').style.display = 'block';
        }
    });
});

// دالة لتحديث رابط المفضلة بناءً على حالة تسجيل الدخول
function updateFavoritesLink() {
    const favoritesLink = document.getElementById('favorites-link');
    if (favoritesLink) {
        favoritesLink.style.display = currentUser ? 'block' : 'none';
    }
}

// تحديث دالة تسجيل الخروج لإخفاء رابط المفضلة
const originalLogout = logout;
logout = async function() {
    await originalLogout();
    updateFavoritesLink();
};

// تحديث دالة updateUserUI لإظهار/إخفاء رابط المفضلة
const originalUpdateUserUI = updateUserUI;
updateUserUI = async function(user) {
    await originalUpdateUserUI(user);
    updateFavoritesLink();
};
